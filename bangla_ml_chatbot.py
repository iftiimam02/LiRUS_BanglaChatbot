import os
import random
from datetime import datetime
import pandas as pd
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.naive_bayes import MultinomialNB
from gtts import gTTS

# === Paths ===
DATASET_PATH = "intent_dataset.csv"
VOICE_CACHE = "voice_cache"

os.makedirs(VOICE_CACHE, exist_ok=True)

# === Load dataset ===
df = pd.read_csv(DATASET_PATH)
texts = df["text"].tolist()
labels = df["intent"].tolist()

# === Train simple ML model ===
vectorizer = CountVectorizer()
X = vectorizer.fit_transform(texts)
model = MultinomialNB()
model.fit(X, labels)

# === Intent-based replies ===
INTENT_REPLIES = {
    "hello": [
        "рж╣рзНржпрж╛рж▓рзЛ! ржЖржорж┐ рж▓рж┐рж░рж╛рж╕ред ржЖржорж┐ ржЖржкржирж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯ ржЕрзНржпрж╛рж╕рж┐рж╕рзНржЯрзНржпрж╛ржирзНржЯред ",
        "рж╕рзНржмрж╛ржЧрждржо! ржЖржорж┐ ржЖржкржирж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯ ржЕрзНржпрж╛рж╕рж┐рж╕рзНржЯрзНржпрж╛ржирзНржЯ рж▓рж┐рж░рж╛рж╕ред"
    ],
    "who_are_you": [
    "ржЖржорж╛рж░ ржирж╛ржо рж▓рж┐рж░рж╛рж╕, LiRUS тАФ A LiDAR-SLAM Utility Robot for Assistive and Service Applications, ржпрж╛ ржЗржлрждрж┐ ржЗржорж╛ржо ржмрж┐ржи рж░рж╛ржЬрзНржЬрж╛ржХ ржУ ржЬрзБржирж╛ржЗржж рж╣рзЛрж╕рж╛ржЗржирзЗрж░ ржпрзМржержнрж╛ржмрзЗ рждрзИрж░рж┐ ржПржХржЯрж┐ ржкрзНрж░рзЛржЬрзЗржХрзНржЯ, ржкрзНрж░ржЬрзЗржХрзНржЯржЯрж┐ рж╕рзБржоржи рж╕рж╛рж╣рж╛ рж╕рзНржпрж╛рж░рзЗрж░ рждрждрзНрждрзНржмрж╛ржмржзрж╛ржирзЗ рж╕ржорзНржкржирзНржи рж╣ржЪрзНржЫрзЗред",
    ],

    "creator": [
        "ржЖржорж╛рж░ ржирж┐рж░рзНржорж╛рждрж╛ ржЗржлрждрж┐ ржЗржорж╛ржо ржмрж┐ржи рж░рж╛ржЬрзНржЬрж╛ржХред рждрж┐ржирж┐ IoT, Robotics ржПржмржВ AI ржирж┐ржпрж╝рзЗ ржХрж╛ржЬ ржХрж░рзЗржиред",
        "ржЗржлрждрж┐ ржЗржорж╛ржо ржмрж┐ржи рж░рж╛ржЬрзНржЬрж╛ржХ ржЗржЙржирж┐ржнрж╛рж░рзНрж╕рж┐ржЯрж┐ ржЕржм ржлрзНрж░ржирзНржЯрж┐ржпрж╝рж╛рж░ ржЯрзЗржХржирзЛрж▓ржЬрж┐, ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ (UFTB)- IoT and Robotics ржмрж┐ржнрж╛ржЧрзЗ ржЕржзрзНржпржпрж╝ржирж░ржд ржПржХржЬржи ржЙржжрзНржнрж╛ржмржирзА ржЫрж╛рждрзНрж░, ржпрж┐ржирж┐ IoT ржУ AI ржкрзНрж░ржпрзБржХрзНрждрж┐ ржирж┐ржпрж╝рзЗ ржХрж╛ржЬ ржХрж░ржЫрзЗржиредред",
        "ржЖржорж╛ржХрзЗ рждрзИрж░рж┐ ржХрж░рзЗржЫрзЗржи ржЗржлрждрж┐ ржЗржорж╛ржо ржмрж┐ржи рж░рж╛ржЬрзНржЬрж╛ржХ ржУ ржЬрзБржирж╛ржЗржж рж╣рзЛрж╕рж╛ржЗржиред"
    ],
    "project": [
        "LiRUS ржорж╛ржирзЗ LiDAR-SLAM Utility Robot for Assistive and Service Applicationsред",
        "LiRUS ржПржХржЯрж┐ рж╕рзНржорж╛рж░рзНржЯ рж╕рж╛рж░рзНржнрж┐рж╕ рж░рзЛржмржЯ ржкрзНрж░ржЬрзЗржХрзНржЯ ржпрж╛ SLAM ржПржмржВ AI ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред",
        "ржЖржорж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯрзЗрж░ ржЙржжрзНржжрзЗрж╢рзНржп рж╣рж▓рзЛ ржорж╛ржирзБрж╖рзЗрж░ рж╕рж╣рж╛ржпрж╝рждрж╛ржпрж╝ рж░рзЛржмржЯрж┐ржХ ржЗржирзНржЯрзЗрж▓рж┐ржЬрзЗржирзНрж╕ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ред"
    ],
    "iot": [
        "IoT ржорж╛ржирзЗ Internet of Things тАФ ржпрзЗржЦрж╛ржирзЗ рж╕рзЗржирзНрж╕рж░ ржЖрж░ ржбрж┐ржнрж╛ржЗрж╕ржЧрзБрж▓рзЛ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗрж░ ржорж╛ржзрзНржпржорзЗ рждржерзНржп ржЖржжрж╛ржи-ржкрзНрж░ржжрж╛ржи ржХрж░рзЗред",
        "IoT рж╣рж▓рзЛ ржПржоржи ржПржХ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржпрзЗржЦрж╛ржирзЗ ржлрж┐ржЬрж┐ржХрзНржпрж╛рж▓ ржЬрж┐ржирж┐рж╕ржЧрзБрж▓рзЛ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗ ржпрзБржХрзНржд рж╣ржпрж╝рзЗ рж╕рзНржорж╛рж░рзНржЯ ржХрж╛ржЬ ржХрж░рзЗред"
    ],
    "ai": [
        "AI ржорж╛ржирзЗ ржХрзГрждрзНрж░рж┐ржо ржмрзБржжрзНржзрж┐ржорждрзНрждрж╛ тАФ ржПржоржи ржПржХ ржкрзНрж░ржпрзБржХрзНрждрж┐ ржпрж╛ рж╢рж┐ржЦрзЗ, ржнрж╛ржмрзЗ ржЖрж░ рж╕рж┐ржжрзНржзрж╛ржирзНржд ржирж┐рждрзЗ ржкрж╛рж░рзЗред",
        "AI ржмрж╛ Artificial Intelligence ржХржорзНржкрж┐ржЙржЯрж╛рж░ржХрзЗ рж╢рзЗржЦрж╛ржпрж╝ ржХрж┐ржнрж╛ржмрзЗ ржорж╛ржирзБрж╖рзЗрж░ ржорждрзЛ ржХрж╛ржЬ ржХрж░рждрзЗ рж╣ржпрж╝ред"
    ],
    "robotics": [
        "рж░рзЛржмрзЛржЯрж┐ржХрзНрж╕ ржПржоржи ржПржХржЯрж┐ рж╢рж╛ржЦрж╛ ржпрзЗржЦрж╛ржирзЗ ржорзЗрж╢рж┐ржиржХрзЗ ржорж╛ржирзБрж╖рзЗрж░ ржорждрзЛ ржХрж╛ржЬ рж╢рзЗржЦрж╛ржирзЛ рж╣ржпрж╝ред",
        "рж░рзЛржмрзЛржЯрж┐ржХрзНрж╕рзЗрж░ рж▓ржХрзНрж╖рзНржп рж╣рж▓рзЛ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рждрзЗ ржкрж╛рж░рзЗ ржПржоржи рж╕рзНржорж╛рж░рзНржЯ рж░рзЛржмржЯ рждрзИрж░рж┐ ржХрж░рж╛ред"
    ],
    "edge_ai": [
        "Edge AI ржорж╛ржирзЗ ржбрж┐ржнрж╛ржЗрж╕рзЗрж░ ржнрзЗрждрж░рзЗржЗ AI ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╣ржпрж╝, ржХрзНрж▓рж╛ржЙржбрзЗ ржкрж╛ржарж╛ржирзЛ рж▓рж╛ржЧрзЗ ржирж╛ред ржПрждрзЗ ржЧрждрж┐ ржмрж╛ржбрж╝рзЗ ржПржмржВ ржбрзЗржЯрж╛ ржирж┐рж░рж╛ржкржж ржерж╛ржХрзЗред",
        "Edge AI рж╕рзНржерж╛ржирзАржпрж╝ржнрж╛ржмрзЗ ржбрзЗржЯрж╛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзЗ тАФ ржлрж▓рзЗ рж░рж┐ржпрж╝рзЗрж▓-ржЯрж╛ржЗржо ржХрж╛ржЬ ржХрж░рж╛ ржпрж╛ржпрж╝ред"
    ],
    "medicine": [
        "ржирж┐ржи, ржЖржкржирж╛рж░ ржУрж╖рзБржзред",
        "ржЖржкржирж╛рж░ ржУрж╖рзБржз рж╕ржоржпрж╝ржорждрзЛ ржирж┐ржиред",
        "ржУрж╖рзБржз ржЦрж╛ржУржпрж╝рж╛рж░ рж╕ржоржпрж╝ рж╣ржпрж╝рзЗржЫрзЗред ржкрж╛ржирж┐ ржирж┐ржпрж╝рзЗ ржирж┐ржиред"
    ],
    "help": [
        "ржЖржорж┐ ржЖржкржирж╛рж░ ржЯрзЗржХржирж┐ржХрзНржпрж╛рж▓ ржкрзНрж░рж╢рзНржирзЗрж░ ржЙрждрзНрждрж░ ржжрж┐рждрзЗ ржкрж╛рж░рж┐, ржкрзНрж░ржЬрзЗржХрзНржЯ ржЧрж╛ржЗржб ржХрж░рждрзЗ ржкрж╛рж░рж┐ред ржХрзА ржЬрж╛ржирждрзЗ ржЪрж╛ржи?",
        "ржЖржкржирж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯ, ржЖржЗржбрж┐ржпрж╝рж╛ ржмрж╛ ржХрзЛржб ржирж┐ржпрж╝рзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржкрж╛рж░рж┐ред ржмрж▓рзБржи, ржХрзА рж▓рж╛ржЧржмрзЗ?",
        "ржЖржорж┐ ржЯрзЗржХ ржУ ржПржХрж╛ржбрзЗржорж┐ржХ рж╕рж╛ржкрзЛрж░рзНржЯрзЗрж░ ржЬржирзНржпржЗ ржЖржЫрж┐ред ржХрзА ржирж┐ржпрж╝рзЗ рж╢рзБрж░рзБ ржХрж░ржм?"
    ],
    "time": [
        f"ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ рж╕ржорзЯ ржЪрж▓ржЫрзЗ {datetime.now().strftime('%I:%M %p')}.",
        f"ржПржЦржи рж╕ржорзЯ {datetime.now().strftime('%I:%M %p')}, ржХрж╛ржЬ ржПржЧрж┐ржпрж╝рзЗ ржЪрж▓ржЫрзЗ рждрзЛ?"
    ],
    "date": [
        f"ржЖржЬ {datetime.now().strftime('%A, %d %B %Y')}ред",
        f"ржЖржЬржХрзЗрж░ рждрж╛рж░рж┐ржЦ {datetime.now().strftime('%d-%m-%Y')}ред ржжрж┐ржиржЯрж╛ ржХрж╛ржЬрзЗ рж▓рж╛ржЧрж╛ржи!"
    ],
    "feeling_good": [
        "ржЪржорзОржХрж╛рж░! ржХрж╛ржЬ ржХрзЗржоржи ржЪрж▓ржЫрзЗ?",
        "ржжрж╛рж░рзБржг! ржПржоржи ржПржирж╛рж░рзНржЬрж┐ ржерж╛ржХрж▓рзЗ рж╕ржм рж╕ржорзНржнржмред"
    ],
    "feeling_bad": [
        "рж╕ржм ржжрж┐ржи ржПржХрж░ржХржо ржиржпрж╝, ржПржХржЯрзБ ржмрж┐рж╢рзНрж░рж╛ржо ржирж┐ржиред",
        "ржоржи ржЦрж╛рж░рж╛ржк? ржЪрж┐ржирзНрждрж╛ ржирзЗржЗ, ржЖржкржирж┐ ржкрж╛рж░ржмрзЗржиред ржЖржорж┐ ржЖржЫрж┐ред"
    ],
    "thank_you": [
        "ржЖржкржирж╛ржХрзЗржУ ржзржирзНржпржмрж╛ржж! ржЖржкржирж╛рж░ рж╕рж╛ржкрзЛрж░рзНржЯрзЗ ржЖржорж┐ ржЖрж░ржУ рж╢рж┐ржЦржЫрж┐ред",
        "рж╕ржмрж╕ржоржпрж╝ ржкрж╛рж╢рзЗ ржЖржЫрж┐ред ржЖржкржирж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯрзЗ рж╢рзБржнржХрж╛ржоржирж╛!",
        "ржЖржкржирж╛рж░ ржХржерж╛ржпрж╝ ржЙрзОрж╕рж╛рж╣ ржкрзЗрж▓рж╛ржо!"
    ],
    "goodbye": [
        "ржмрж┐ржжрж╛ржпрж╝, ржЖржмрж╛рж░ ржХржерж╛ рж╣ржмрзЗ!",
        "ржнрж╛рж▓рзЛ ржерж╛ржХржмрзЗржи! ржЖржмрж╛рж░ ржжрзЗржЦрж╛ рж╣ржмрзЗред",
        "ржЖржкржирж╛рж░ ржХрж╛ржЬ рж╕ржлрж▓ рж╣рзЛржХ тАФ ржмрж┐ржжрж╛ржпрж╝!"
    ],
    "fallback": [
        "ржжрзБржГржЦрж┐ржд, ржЖржорж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░рж┐ржирж┐ред ржПржХржЯрзБ ржнрж┐ржирзНржиржнрж╛ржмрзЗ ржмрж▓ржмрзЗржи?",
        "ржорж╛ржл ржХрж░ржмрзЗржи, ржкрзНрж░рж╢рзНржиржЯрж╛ ржарж┐ржХ ржзрж░рждрзЗ ржкрж╛рж░рж┐ржирж┐ред ржЖржмрж╛рж░ ржмрж▓ржмрзЗржи?",
        "ржЖржорж┐ ржПржЦржиржУ рж╢рж┐ржЦржЫрж┐ тАФ ржПржХржЯрзБ ржкрж░рж┐рж╖рзНржХрж╛рж░ржнрж╛ржмрзЗ ржмрж▓ржмрзЗржи?"
    ]
}

# === Keyword mapping (for quick matches) ===
KEYWORD_INTENTS = {
    "рж╣рзНржпрж╛рж▓рзЛ": "hello",
    "рж╣рж╛ржЗ": "hello",
    "рждрзБржорж┐ ржХрзЗ": "who_are_you",
    "рждрзЛржорж╛рж░ ржирж╛ржо": "who_are_you",
    "рждрзЛржорж╛ржХрзЗ ржХрзЗ ржмрж╛ржирж┐ржпрж╝рзЗржЫрзЗ": "creator",
    "рждрзЛржорж╛рж░ ржкрзНрж░ржЬрзЗржХрзНржЯ": "project",
    "ржЖржЗржУржЯрж┐": "iot",
    "рж░рзЛржмрзЛржЯрж┐ржХрзНрж╕": "robotics",
    "ржПржЖржЗ": "ai",
    "ржПржЬ ржПржЖржЗ": "edge_ai",
    "ржУрж╖рзБржз": "medicine",
    "рж╕рж╛рж╣рж╛ржпрзНржп": "help",
    "рж╕ржоржпрж╝": "time",
    "рж╕ржорзЯ": "time",
    "ржжрж┐ржи": "date",
    "ржнрж╛рж▓рзЛ ржЖржЫрж┐": "feeling_good",
    "ржЦрж╛рж░рж╛ржк": "feeling_bad",
    "ржзржирзНржпржмрж╛ржж": "thank_you",
    "ржмрж┐ржжрж╛ржпрж╝": "goodbye"
}

# === Predict user intent ===
def predict_intent(text):
    # Keyword check first
    for kw, kw_intent in KEYWORD_INTENTS.items():
        if kw in text:
            return kw_intent
    # Fallback to ML model
    X_test = vectorizer.transform([text])
    pred = model.predict(X_test)[0]
    return pred

# === Generate reply ===
def get_reply(text):
    intent = predict_intent(text)
    replies = INTENT_REPLIES.get(intent, INTENT_REPLIES["fallback"])
    return random.choice(replies)

# === Convert reply to speech ===
def text_to_speech_bangla(text, filename=None):
    if filename is None:
        safe_text = text.replace(" ", "_").replace("?", "").replace("!", "")
        filename = os.path.join(VOICE_CACHE, f"{safe_text}.mp3")
    if not os.path.exists(filename):
        tts = gTTS(text=text, lang="bn")
        tts.save(filename)
    return filename

# === Example Run (for test) ===
if __name__ == "__main__":
    while True:
        user_input = input("ЁЯзСтАНЁЯТ╗ ржЖржкржирж┐: ")
        if user_input.lower() in ["ржмрж┐ржжрж╛ржпрж╝", "exit", "quit"]:
            print("ЁЯдЦ рж▓рж┐рж░рж╛рж╕: ржмрж┐ржжрж╛ржпрж╝! ржЖржмрж╛рж░ ржХржерж╛ рж╣ржмрзЗред")
            break
        reply = get_reply(user_input)
        print("ЁЯдЦ рж▓рж┐рж░рж╛рж╕:", reply)
        audio_path = text_to_speech_bangla(reply)
        os.system(f"start {audio_path}")  # Opens MP3 on Windows

#F:
#cd LiRUS_BanglaChatbot
#venv\Scripts\activate
#python app.py
#